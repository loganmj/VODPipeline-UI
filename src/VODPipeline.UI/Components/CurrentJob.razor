@using VODPipeline.UI.Data
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Logging
@implements IAsyncDisposable
@inject ILogger<CurrentJob> Logger

<div class="current-job">
    @if (JobStatus?.IsRunning == true)
    {
        <h4>Current Job</h4>
        <div class="job-details">
            <div class="job-field">
                <strong>File:</strong> @JobStatus.CurrentFile
            </div>
            <div class="job-field">
                <strong>Stage:</strong> @JobStatus.Stage
            </div>
            <div class="job-field">
                <strong>Progress:</strong> @(JobStatus.Percent ?? 0)%
            </div>
            @if (JobStatus.EstimatedTimeRemaining.HasValue)
            {
                <div class="job-field">
                    <strong>ETA:</strong> @FormatTimeSpan(JobStatus.EstimatedTimeRemaining.Value)
                </div>
            }
            @if (JobStatus.ElapsedTime.HasValue)
            {
                <div class="job-field">
                    <strong>Elapsed:</strong> @FormatTimeSpan(JobStatus.ElapsedTime.Value)
                </div>
            }
            @if (JobStatus.LastUpdated.HasValue)
            {
                <div class="job-field text-muted">
                    <small>Last Updated: @JobStatus.LastUpdated.Value.ToString("HH:mm:ss")</small>
                </div>
            }
        </div>
    }
    else
    {
        <div class="no-job">
            <p>No active job running</p>
        </div>
    }
    @if (signalRConnectionFailed)
    {
        <div class="connection-warning">
            <small>⚠️ Live updates unavailable - displaying cached status</small>
        </div>
    }
</div>

@code {
    [Parameter]
    public JobStatus? JobStatus { get; set; }

    [Parameter]
    public string? HubUrl { get; set; }

    private HubConnection? hubConnection;
    private bool signalRConnectionFailed = false;
    private string? previousHubUrl;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(HubUrl))
        {
            await InitializeSignalRConnection();
            previousHubUrl = HubUrl;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Handle HubUrl changes
        if (HubUrl != previousHubUrl)
        {
            if (hubConnection is not null)
            {
                await CleanupSignalRConnection();
            }

            if (!string.IsNullOrEmpty(HubUrl))
            {
                await InitializeSignalRConnection();
            }
            
            previousHubUrl = HubUrl;
        }
    }

    private async Task InitializeSignalRConnection()
    {
        try
        {
            signalRConnectionFailed = false;
            
            hubConnection = new HubConnectionBuilder()
                .WithUrl(HubUrl!)
                .WithAutomaticReconnect()
                .Build();

            hubConnection.On<JobStatus>("JobStatusUpdated", async (updatedStatus) =>
            {
                try
                {
                    await InvokeAsync(() =>
                    {
                        JobStatus = updatedStatus;
                        StateHasChanged();
                    });
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error handling JobStatusUpdated SignalR event.");
                }
            });

            await hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            signalRConnectionFailed = true;
            Logger.LogError(ex, "Failed to establish SignalR connection to hub at {HubUrl}", HubUrl);
        }
    }

    private async Task CleanupSignalRConnection()
    {
        var connection = hubConnection;
        if (connection is not null)
        {
            hubConnection = null; // Clear reference first to prevent reuse
            
            try
            {
                await connection.StopAsync();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error while stopping SignalR hub connection.");
            }
            
            await connection.DisposeAsync();
        }
    }

    private string FormatTimeSpan(TimeSpan timeSpan)
    {
        if (timeSpan < TimeSpan.Zero)
        {
            return "N/A";
        }
        
        if (timeSpan.TotalHours >= 1)
        {
            return $"{(int)timeSpan.TotalHours}h {timeSpan.Minutes}m {timeSpan.Seconds}s";
        }
        else if (timeSpan.TotalMinutes >= 1)
        {
            return $"{timeSpan.Minutes}m {timeSpan.Seconds}s";
        }
        else
        {
            return $"{timeSpan.Seconds}s";
        }
    }

    public async ValueTask DisposeAsync()
    {
        await CleanupSignalRConnection();
    }
}
