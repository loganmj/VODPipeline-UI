@using VODPipeline.UI.Data
@using VODPipeline.UI.Services
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Logging
@implements IAsyncDisposable
@inject ILogger<SystemHealth> Logger
@inject HealthService HealthService

<div class="system-health">
    <h4>System Health</h4>
    
    @if (HealthStatus != null)
    {
        <div class="health-grid">
            <div class="health-component">
                <div class="health-indicator @GetStatusClass(HealthStatus.Function.Status)" 
                     role="status" 
                     aria-label="Function status: @GetStatusText(HealthStatus.Function.Status)"></div>
                <div class="health-details">
                    <strong>Function <span class="status-text">(@GetStatusText(HealthStatus.Function.Status))</span></strong>
                    @if (HealthStatus.Function.LastHeartbeat.HasValue)
                    {
                        <small>Last heartbeat: @FormatTimestamp(HealthStatus.Function.LastHeartbeat.Value)</small>
                    }
                    @if (!string.IsNullOrEmpty(HealthStatus.Function.Message))
                    {
                        <small class="health-message">@HealthStatus.Function.Message</small>
                    }
                </div>
            </div>

            <div class="health-component">
                <div class="health-indicator @GetStatusClass(HealthStatus.API.Status)" 
                     role="status" 
                     aria-label="API status: @GetStatusText(HealthStatus.API.Status)"></div>
                <div class="health-details">
                    <strong>API <span class="status-text">(@GetStatusText(HealthStatus.API.Status))</span></strong>
                    @if (HealthStatus.API.LastHeartbeat.HasValue)
                    {
                        <small>Last heartbeat: @FormatTimestamp(HealthStatus.API.LastHeartbeat.Value)</small>
                    }
                    @if (!string.IsNullOrEmpty(HealthStatus.API.Message))
                    {
                        <small class="health-message">@HealthStatus.API.Message</small>
                    }
                </div>
            </div>

            <div class="health-component">
                <div class="health-indicator @GetStatusClass(HealthStatus.Database.Status)" 
                     role="status" 
                     aria-label="Database status: @GetStatusText(HealthStatus.Database.Status)"></div>
                <div class="health-details">
                    <strong>Database <span class="status-text">(@GetStatusText(HealthStatus.Database.Status))</span></strong>
                    @if (HealthStatus.Database.LastHeartbeat.HasValue)
                    {
                        <small>Last heartbeat: @FormatTimestamp(HealthStatus.Database.LastHeartbeat.Value)</small>
                    }
                    @if (!string.IsNullOrEmpty(HealthStatus.Database.Message))
                    {
                        <small class="health-message">@HealthStatus.Database.Message</small>
                    }
                </div>
            </div>

            <div class="health-component">
                <div class="health-indicator @GetStatusClass(HealthStatus.FileShare.Status)" 
                     role="status" 
                     aria-label="File Share status: @GetStatusText(HealthStatus.FileShare.Status)"></div>
                <div class="health-details">
                    <strong>File Share <span class="status-text">(@GetStatusText(HealthStatus.FileShare.Status))</span></strong>
                    @if (HealthStatus.FileShare.LastHeartbeat.HasValue)
                    {
                        <small>Last heartbeat: @FormatTimestamp(HealthStatus.FileShare.LastHeartbeat.Value)</small>
                    }
                    @if (!string.IsNullOrEmpty(HealthStatus.FileShare.Message))
                    {
                        <small class="health-message">@HealthStatus.FileShare.Message</small>
                    }
                </div>
            </div>
        </div>

        @if (HealthStatus.LastUpdated.HasValue)
        {
            <div class="status-footer text-muted">
                <small>Last updated: @HealthStatus.LastUpdated.Value.ToLocalTime().ToString("HH:mm:ss zzz")</small>
            </div>
        }
    }
    else
    {
        <div class="no-status">
            <p>Loading health status...</p>
        </div>
    }

    <div class="signalr-status">
        @if (hubConnection?.State == HubConnectionState.Connected)
        {
            <small class="connection-status connected">ðŸŸ¢ Live updates active</small>
        }
        else if (hubConnection?.State == HubConnectionState.Connecting || hubConnection?.State == HubConnectionState.Reconnecting)
        {
            <small class="connection-status connecting">ðŸŸ¡ Connecting...</small>
        }
        else if (signalRConnectionFailed)
        {
            <small class="connection-status disconnected">ðŸ”´ Live updates unavailable</small>
        }
        else
        {
            <small class="connection-status unknown">âšª No SignalR connection</small>
        }
    </div>
</div>

@code {
    // Component name constants for event handling
    private const string ComponentNameFunction = "Function";
    private const string ComponentNameAPI = "API";
    private const string ComponentNameDatabase = "Database";
    private const string ComponentNameFileShare = "FileShare";

    [Parameter]
    public SystemHealthStatus? HealthStatus { get; set; }

    [Parameter]
    public string? HubUrl { get; set; }

    private HubConnection? hubConnection;
    private bool signalRConnectionFailed = false;
    private string? previousHubUrl;

    protected override async Task OnInitializedAsync()
    {
        // Load initial health data from API only if no value was provided by the parent
        if (HealthStatus == null)
        {
            try
            {
                HealthStatus = await HealthService.GetHealthAsync();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to load initial health data from API.");
            }
        }

        if (!string.IsNullOrEmpty(HubUrl))
        {
            await InitializeSignalRConnection();
            previousHubUrl = HubUrl;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (HubUrl != previousHubUrl)
        {
            if (hubConnection is not null)
            {
                await CleanupSignalRConnection();
            }

            if (!string.IsNullOrEmpty(HubUrl))
            {
                await InitializeSignalRConnection();
            }
            
            previousHubUrl = HubUrl;
        }
    }

    private async Task InitializeSignalRConnection()
    {
        try
        {
            signalRConnectionFailed = false;
            
            hubConnection = new HubConnectionBuilder()
                .WithUrl(HubUrl!)
                .WithAutomaticReconnect()
                .Build();

            hubConnection.Reconnecting += async (error) =>
            {
                await InvokeAsync(() =>
                {
                    signalRConnectionFailed = true;
                });
            };

            hubConnection.Reconnected += async (connectionId) =>
            {
                await InvokeAsync(() =>
                {
                    signalRConnectionFailed = false;
                });
            };

            hubConnection.Closed += async (error) =>
            {
                await InvokeAsync(() =>
                {
                    signalRConnectionFailed = true;
                });
            };

            hubConnection.On<SystemHealthStatus>("SystemHealthUpdated", async (updatedStatus) =>
            {
                try
                {
                    await InvokeAsync(() =>
                    {
                        HealthStatus = updatedStatus;
                        StateHasChanged();
                    });
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error handling SystemHealthUpdated SignalR event.");
                }
            });

            // Subscribe to individual component health events
            hubConnection.On<SubsystemHealth>("functionHeartbeat", async (subsystemHealth) =>
            {
                await HandleComponentHealthUpdate(subsystemHealth, ComponentNameFunction, "functionHeartbeat");
            });

            hubConnection.On<SubsystemHealth>("apiHeartbeat", async (subsystemHealth) =>
            {
                await HandleComponentHealthUpdate(subsystemHealth, ComponentNameAPI, "apiHeartbeat");
            });

            hubConnection.On<SubsystemHealth>("dbStatusChanged", async (subsystemHealth) =>
            {
                await HandleComponentHealthUpdate(subsystemHealth, ComponentNameDatabase, "dbStatusChanged");
            });

            hubConnection.On<SubsystemHealth>("fileShareStatusChanged", async (subsystemHealth) =>
            {
                await HandleComponentHealthUpdate(subsystemHealth, ComponentNameFileShare, "fileShareStatusChanged");
            });

            await hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            signalRConnectionFailed = true;
            Logger.LogError(ex, "Failed to establish SignalR connection to hub at {HubUrl}", HubUrl);
            
            try
            {
                if (hubConnection is not null)
                {
                    await hubConnection.DisposeAsync();
                }
            }
            catch (Exception disposeEx)
            {
                Logger.LogError(disposeEx, "Error disposing SignalR hub connection after failed start.");
            }
            finally
            {
                hubConnection = null;
            }
        }
    }

    private async Task HandleComponentHealthUpdate(SubsystemHealth subsystemHealth, string componentName, string eventName)
    {
        try
        {
            await InvokeAsync(() =>
            {
                if (HealthStatus == null)
                {
                    HealthStatus = new SystemHealthStatus();
                }

                switch (componentName)
                {
                    case ComponentNameFunction:
                        HealthStatus.Function = subsystemHealth;
                        break;
                    case ComponentNameAPI:
                        HealthStatus.API = subsystemHealth;
                        break;
                    case ComponentNameDatabase:
                        HealthStatus.Database = subsystemHealth;
                        break;
                    case ComponentNameFileShare:
                        HealthStatus.FileShare = subsystemHealth;
                        break;
                    default:
                        Logger.LogWarning("Received update for unknown component: {ComponentName}", componentName);
                        return;
                }
                HealthStatus.LastUpdated = DateTime.UtcNow;
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling {EventName} SignalR event.", eventName);
        }
    }

    private async Task CleanupSignalRConnection()
    {
        var connection = hubConnection;
        if (connection is not null)
        {
            hubConnection = null;
            
            try
            {
                await connection.StopAsync();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error while stopping SignalR hub connection.");
            }

            try
            {
                await connection.DisposeAsync();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error while disposing SignalR hub connection.");
            }
        }
    }

    private string GetStatusClass(HealthStatus healthStatus)
    {
        return healthStatus switch
        {
            Data.HealthStatus.Healthy => "status-healthy",
            Data.HealthStatus.Degraded => "status-degraded",
            Data.HealthStatus.Unhealthy => "status-unhealthy",
            _ => "status-unknown"
        };
    }

    private string GetStatusText(HealthStatus healthStatus)
    {
        return healthStatus switch
        {
            Data.HealthStatus.Healthy => "Healthy",
            Data.HealthStatus.Degraded => "Degraded",
            Data.HealthStatus.Unhealthy => "Unhealthy",
            _ => "Unknown"
        };
    }

    private string FormatTimestamp(DateTime timestamp)
    {
        var localTime = timestamp.ToLocalTime();
        var now = DateTime.Now;
        var diff = now - localTime;

        // Handle future timestamps (e.g., due to clock skew)
        if (diff.TotalSeconds < 0)
        {
            return localTime.ToString("MMM d, HH:mm");
        }

        if (diff.TotalSeconds < 60)
        {
            return "just now";
        }
        else if (diff.TotalMinutes < 60)
        {
            return $"{(int)diff.TotalMinutes}m ago";
        }
        else if (diff.TotalHours < 24)
        {
            return $"{(int)diff.TotalHours}h ago";
        }
        else
        {
            return localTime.ToString("MMM d, HH:mm");
        }
    }

    public async ValueTask DisposeAsync()
    {
        await CleanupSignalRConnection();
    }
}
